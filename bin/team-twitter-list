#!/usr/bin/env ruby
require 'rubygems'
require 'rubygems/gem_runner'
require 'rubygems/exceptions'
require 'yaml'

def install_client
  begin
    Gem::GemRunner.new.run ['install', 'twitter', '-v 5.16']
  rescue Gem::SystemExitException => e
  end

  require 'twitter'
end

def init_client
  @client = Twitter::REST::Client.new({
    consumer_key: ENV['TWITTER_CONSUMER_KEY'],
    consumer_secret: ENV['TWITTER_CONSUMER_SECRET'],
    access_token: ENV['TWITTER_ACCESS_TOKEN'],
    access_token_secret: ENV['TWITTER_ACCESS_TOKEN_SECRET']
  });
end

def get_list_data
  begin
    @list = @client.list('gitlab-team')
  rescue
    @list = @client.create_list('GitLab Team')
  end

  @current_users = @client.list_members(@list, count: 5000).attrs[:users]
    .map { |user| user[:screen_name].downcase }
end

def get_team_data
  data_path = File.join(__dir__, '../data/team.yml')
  team_data = YAML.load_file(data_path)

  @team_twitters = team_data.map do |user|
    twitter = user['twitter']
    twitter.downcase if twitter
  end.compact
end

def add_new_users
  new_users = @team_twitters.select do |user|
    !@current_users.include?(user)
  end.compact

  new_users.each_slice(100) do |users|
    @client.add_list_members(@list, users)
  end
end

def remove_old_users
  old_users = @current_users.select do |user|
    !@team_twitters.include?(user)
  end.compact

  old_users.each_slice(100) do |users|
    @client.remove_list_members(@list, users)
  end
end

install_client

init_client

get_list_data

get_team_data

add_new_users

remove_old_users
