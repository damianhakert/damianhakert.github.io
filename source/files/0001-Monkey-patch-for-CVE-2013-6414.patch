From 147a1035ab57a00d0a9e2301e29d36556db76e91 Mon Sep 17 00:00:00 2001
From: Jacob Vosmaer <contact@jacobvosmaer.nl>
Date: Wed, 4 Dec 2013 17:39:19 +0100
Subject: [PATCH] Monkey patch for CVE-2013-6414

---
 config/initializers/cve_2013_6414.rb | 21 +++++++++++++++++++++
 1 file changed, 21 insertions(+)
 create mode 100644 config/initializers/cve_2013_6414.rb

diff --git a/config/initializers/cve_2013_6414.rb b/config/initializers/cve_2013_6414.rb
new file mode 100644
index 0000000..f166e4d
--- /dev/null
+++ b/config/initializers/cve_2013_6414.rb
@@ -0,0 +1,21 @@
+# Monkey patch for Ruby on Rails vulnerability CVE-2013-6414
+# https://groups.google.com/d/msg/ruby-security-ann/A-ebV4WxzKg/KNPTbX8XAQUJ
+
+ActiveSupport.on_load(:action_view) do
+  ActionView::LookupContext::DetailsKey.class_eval do
+    class << self
+      alias :old_get :get
+
+      def get(details)
+        if details[:formats]
+          details = details.dup
+          syms    = Set.new Mime::SET.symbols
+          details[:formats] = details[:formats].select { |v|
+            syms.include? v
+          }
+        end
+        old_get details
+      end
+    end
+  end
+end
-- 
1.8.5

